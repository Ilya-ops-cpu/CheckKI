# CheckKI
Код представляет собой обработчик события в системе Битрикс24, который предотвращает перемещение сделки на определенные стадии производства,
если связанная сделка КИ (ключевого клиента) не завершена.

Используемые классы:
CheckKIHelper - проверка статуса сделки КИ
AddComment - добавление комментариев в сделку

Проверка целевой стадии
Определяет, перемещается ли сделка на одну из запрещенных стадий производства:
php
$stage = ['C8:4', 'C8:5', 'C8:UC_2SK0NX', 'C8:7'];
Получение данных сделки
Запрашивает информацию о текущей сделке:
php
$factory = Service\Container::getInstance()->getFactory(\CCrmOwnerType::Deal);
$arrDeal = $factory->getItems([...]);
Извлечение контактного ID
Получает CONTACT_ID из данных сделки
Проверка условий
Если контакт не привязан (!$contactID) → возвращает false
Если контакт привязан → проверяет статус КИ
Валидация статуса КИ
Вызывает CheckKIHelper::isStageAllowed($contactID)
isStageAllowed
    Назначение: Определяет, разрешены ли операции для контакта на основе стадии сделки КИ.

    Логика работы:

    Вызывает checkStageKI() для получения текущей стадии
    checkStageKI
        Назначение: Получает текущую стадию сделки КИ для указанного контакта.

        Логика работы:

        Создает фабрику для работы со сделками через Service\Container

        Выполняет запрос к БД с фильтрами:

        CONTACT_ID - идентификатор контакта

        CATEGORY_ID - категория сделок КИ (41)

        Выбирает только поле STAGE_ID

        Извлекает стадию из последней найденной сделки

        Возвращает:

        string - идентификатор стадии сделки КИ

    Если стадия не найдена (is_null($stage)) → возвращает true

    Проверяет, находится ли стадия в списке финальных стадий

    Возвращает результат проверки

    Бизнес-логика:

    true - операции разрешены (сделка КИ в финальной стадии или не найдена)

    false - операции запрещены (сделка КИ в активной стадии)
Если проверка не пройдена → добавляет комментарий в сделку с помощью AddComment
AddComment
    Назначение: Добавляет системный комментарий в указанную сделку.

    Параметры:

    $dealID (int) - идентификатор сделки, в которую добавляется комментарий

    Логика работы:

    Вызывает статический метод \Bitrix\Crm\Timeline\CommentEntry::create()

    Передает конфигурационный массив с параметрами комментария

    Не возвращает значения (void)
